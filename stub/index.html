<!DOCTYPE html>
<html>

<style>
  body {
    background-color: #232323;
  }

  table {
    padding: 20px;
    border: solid 1px grey;
    background-color: #9a9a9a;
    color: black;
    margin: 50px;
  }

  td {
    border: solid 1px grey;
    padding: 4px 8px;
  }

  tr:nth-child(2n) {
    background-color: #aeaeae;
  }

  td.ar.allocated {
    background-color: green;
  }

  td.ar.attention {
    background-color: red;
  }

  .modal {
    background-color: white;
    height: 300px;
    padding: 20px;
  }

  .modal-wrapper.hide {
    display: none;
  }

  .modal-wrapper.show {
    position: absolute;
    display: flex;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    justify-content: center;
    align-items: center;
    background-color: #00000080;
  }
</style>

<body>
  <table id="transactions" class="table_list tablesorter tablesorter-default" cellpadding="0" cellspacing="0"
    role="grid" aria-describedby="transactions_pager_info">
    <thead>
      <tr class="tablesorter-headerRow" role="row">
        <th data-column="0" class="tablesorter-header tablesorter-headerDesc" tabindex="0" scope="col"
          role="columnheader" aria-disabled="false" aria-controls="transactions" unselectable="on"
          aria-sort="descending" aria-label="Date: Descending sort applied, activate to apply an ascending sort"
          style="user-select: none;">
          <div class="tablesorter-header-inner">Date</div>
        </th>
        <th data-column="1" class="tablesorter-header tablesorter-headerUnSorted" tabindex="0" scope="col"
          role="columnheader" aria-disabled="false" aria-controls="transactions" unselectable="on" aria-sort="none"
          aria-label="Description: No sort applied, activate to apply an ascending sort" style="user-select: none;">
          <div class="tablesorter-header-inner">Description</div>
        </th>
        <th class="ar tablesorter-header tablesorter-headerUnSorted" data-column="2" tabindex="0" scope="col"
          role="columnheader" aria-disabled="false" aria-controls="transactions" unselectable="on" aria-sort="none"
          aria-label="Money In: No sort applied, activate to apply an ascending sort" style="user-select: none;">
          <div class="tablesorter-header-inner">Money In</div>
        </th>
        <th class="ar tablesorter-header tablesorter-headerUnSorted" data-column="3" tabindex="0" scope="col"
          role="columnheader" aria-disabled="false" aria-controls="transactions" unselectable="on" aria-sort="none"
          aria-label="Money Out: No sort applied, activate to apply an ascending sort" style="user-select: none;">
          <div class="tablesorter-header-inner">Money Out</div>
        </th>
        <th class="ar tablesorter-header tablesorter-headerUnSorted" data-column="4" tabindex="0" scope="col"
          role="columnheader" aria-disabled="false" aria-controls="transactions" unselectable="on" aria-sort="none"
          aria-label="Balance: No sort applied, activate to apply an ascending sort" style="user-select: none;">
          <div class="tablesorter-header-inner">Balance</div>
        </th>
        <th class="ar tablesorter-header tablesorter-headerUnSorted" colspan="2" data-column="5" tabindex="0"
          scope="col" role="columnheader" aria-disabled="false" aria-controls="transactions" unselectable="on"
          aria-sort="none" aria-label="Status: No sort applied, activate to apply an ascending sort"
          style="user-select: none;">
          <div class="tablesorter-header-inner">Status</div>
        </th>
      </tr>
    </thead>
    <tbody aria-live="polite" aria-relevant="all">
      <tr class="odd" data-type="s" data-urn="2">
        <td><span style="display:none">1548806400266B</span>30/01/2019</td>
        <td>BILL PAYMENT VIA FASTER PAYMENT TO HMRC</td>
        <td class="ar"></td>
        <td class="ar">£490</td>
        <td class="ar">£500</td>
        <td class="ar attention" nowrap="nowrap" width="40">
        </td>
        <td class="ar arrow_down" nowrap="nowrap" width="20"></td>
      </tr>
      <tr class="odd" data-type="s" data-urn="5">
        <td><span style="display:none">1548720000263B</span>29/01/2019</td>
        <td>CARD PAYMENT TO TFL TRAVEL CH,5.00 GBP ON 27-01-2019</td>
        <td class="ar"></td>
        <td class="ar">£5.00</td>
        <td class="ar">£990.00</td>
        <td class="ar allocated" nowrap="nowrap" width="40">
        </td>
        <td class="ar arrow_down" nowrap="nowrap" width="20"></td>
      </tr>
      <tr class="odd" data-type="s" data-urn="6">
        <td><span style="display:none">1548720000262B</span>29/01/2019</td>
        <td>CARD PAYMENT TO TFL TRAVEL CH,5.00 GBP ON 26-01-2019</td>
        <td class="ar"></td>
        <td class="ar">£5.00</td>
        <td class="ar">£995.00</td>
        <td class="ar attention" nowrap="nowrap" width="40">
        </td>
        <td class="ar arrow_down" nowrap="nowrap" width="20"></td>
      </tr>
      <tr class="odd" data-type="s" data-urn="7">
        <td><span style="display:none">1548720000261B</span>27/01/2019</td>
        <td>BILL PAYMENT VIA FASTER PAYMENT TO KUNAL</td>
        <td class="ar"></td>
        <td class="ar">£1,000.00</td>
        <td class="ar">£1,000.00</td>
        <td class="ar attention" nowrap="nowrap" width="40">
        </td>
        <td class="ar arrow_down" nowrap="nowrap" width="20"></td>
      </tr>
    </tbody>
    <tfoot>
      <tr class="table_list_total">
        <td colspan="2" class="ar tablesorter-headerDesc" data-column="0">Total:</td>
        <td class="ar b" data-column="2">£2,000.00</td>
        <td class="ar b" data-column="3">£1,500.00</td>
        <td class="ar b" data-column="4">£500.00</td>
        <td data-column="5">&nbsp;</td>
      </tr>
    </tfoot>
  </table>
  <div id='loading' class='modal-wrapper show'>
    <div class='modal'>
      Loading...
    </div>
  </div>
  <div id='modal-wrapper' class='modal-wrapper hide'>
    <div class='modal'>
      <h2>Allocate transaction</h1>
        <p>
          Category
        </p>
        <p>
          <select id='category' value='default'>
            <option value='default'>---Select Category---</option>
            <option value='expenses'>Expenses</option>
            <option value='tax'>Tax</option>
            <option value='dividends'>Dividends</option>
          </select>
        </p>
        <br />
        <p>
          Explanation
        </p>
        <p>
          <select id='explanation' value='default'>
            <option value='default'>---Select Explanation---</option>
            <option value='travel'>Travel</option>
            <option value='income'>Income</option>
          </select>
        </p>
        <br />
        <button id='modal-submit'>Allocate</button>
        <button id='modal-close'>Close</button>
    </div>
  </div>
</body>

<script>
  window.addEventListener('load', async () => {
    console.log('stub loaded')

    async function init() {
      console.log('init script')
      const modalWrapper = document.getElementById('modal-wrapper')
      const modalSubmit = document.getElementById('modal-submit')
      const modalClose = document.getElementById('modal-close')

      const transactions = document.querySelectorAll('#transactions > tbody > tr')
      for (let line of transactions) {
        line.addEventListener('click', () => {
          console.log('assigning transaction row listener')
          showAllocateTransactionModal(line)
        })
      }

      modalClose.addEventListener('click', () => {
        hideModal()
      })

      function hideModal() {
        modalWrapper.classList.remove('show')
        modalWrapper.classList.add('hide')
      }

      function showModal() {
        modalWrapper.classList.remove('hide')
        modalWrapper.classList.add('show')
      }

      function showAllocateTransactionModal(row) {
        const urn = row.dataset.urn
        const col = row.children[5]
        showModal()
        const { category, explanation } = col.dataset
        document.getElementById('category').value = category || 'default'
        document.getElementById('explanation').value = explanation || 'default'

        modalSubmit.addEventListener('click', () => {
          allocateTransaction(urn)
          updateProcessedTransactions()
          hideModal()
        })
      }

      function searchToObject(search) {
        return search.substring(1).split("&").reduce(function (result, value) {
          var parts = value.split('=');
          if (parts[0]) result[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1]);
          return result;
        }, {})
      }

      function allocateTransaction(urn) {
        const s = searchToObject(location.search)
        location.search = s.processedTransactions ? `?processedTransactions=${s.processedTransactions},${urn}` : `?processedTransactions=${urn}`
      }

      function updateProcessedTransactions() {
        const s = searchToObject(location.search)
        if (s.processedTransactions) {
          transactions.forEach(transaction => {
            const urn = transaction.getAttribute('data-urn')
            if (s.processedTransactions.includes(urn)) {
              const col = transaction.children[5]
              col.classList.remove('attention')
              col.classList.add('allocated')
            }
          })
        }
      }
      updateProcessedTransactions()
    }

    async function simulateDelay(maxSeconds = 2) {
      const wait = Math.random() * maxSeconds * 1000
      return new Promise(resolve => setTimeout(() => {
        console.log('delay over')
        const loading = document.getElementById('loading')
        loading.classList.remove('show')
        loading.classList.add('hide')
        init()
      }, wait))
    }
    await simulateDelay()
  })
</script>

</html>